# Create your views here.
from django.http import HttpResponse
from django.shortcuts import render_to_response
from django.forms.models import modelformset_factory
from codex.web.models import *

from django.core import validators
from django.http import HttpResponseRedirect
from codex.settings import MEDIA_URL,STATIC_URL
from decimal import *

from django.template import Context, Template, RequestContext

from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger

CHAR_RELATIONSHIP_CHOICES = (
        ('SON', ('Hijo')),
        ('FATHER', ('Padre')),
        ('BROTHER', ('Hermano')),
        ('SUBDIT', ('Subdito')),
        ('GROUP', ('Grupo')),
        ('NEMESIS', ('Nemesis')),
        ('FRIEND', ('Amigo')),
        ('MASTER', ('Maestro')),
        ('APPRENTICE', ('Aprendiz')),
        ('FAMILIAR', ('Familiar (animal)')),
        ('EMPLOYEE', ('Empleado')),
)


def IndexView(request):
    chars = Character.objects.all().order_by('-last_updated')[:3]
    objects = Object.objects.all().order_by('-last_updated')[:3]
    creatures = Creature.objects.all().order_by('-last_updated')[:3]
    chronicles = Chronicle.objects.all().order_by('-last_updated')[:3]
    locations = Location.objects.all().order_by('-last_updated')[:3]
    adventures = Adventure.objects.all().order_by('-last_updated')[:3]
    index_list = {'characters':chars, 'objects':objects, 'creatures':creatures, 'chronicles':chronicles, 'locations':locations, 'adventures':adventures}
    return render_to_response('web/index.html', {'index_list':index_list})

def getCharacterRelations(character):

	characterlist1 = CharacterRelationship.objects.filter(character1__name = character.name)
	characterlist2 = CharacterRelationship.objects.filter(character2__name = character.name)

	return (characterlist1,characterlist2)

def CharacterDetailView(request, pk):
    character = Character.objects.get(id=pk)


    relatedobjectsbytags = getRelatedByTags(character)


    relatedcharacters = getCharacterRelations(character)
    return render_to_response('web/character_detail.html', {
            "object": character, "relatedcharacters1":relatedcharacters[0],"relatedcharacters2":relatedcharacters[1],"relatedobjectsbytags":relatedobjectsbytags,'MEDIA_URL':MEDIA_URL,'STATIC_URL':STATIC_URL,
    })

def CharacterSectionView(request):
    allobjects = Character.objects.all()

    paginator = Paginator(allobjects, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/character_section.html",{'results':objects})


def getCreatureRelations(creature):

	creaturelist1 = CreatureRelationship.objects.filter(creature1__name = creature.name)
	creaturelist2 = CreatureRelationship.objects.filter(creature2__name = creature.name)

	return (creaturelist1,creaturelist2)

def CreatureDetailView(request, pk):
    creature = Creature.objects.get(id=pk)


    relatedobjectsbytags = getRelatedByTags(creature)


    relatedcreatures = getCreatureRelations(creature)
    return render_to_response('web/creature_detail.html', {
            "object": creature, "relatedcreatures1":relatedcreatures[0],"relatedcreatures2":relatedcreatures[1],"relatedobjectsbytags":relatedobjectsbytags,'MEDIA_URL':MEDIA_URL,'STATIC_URL':STATIC_URL,
    })

def CreatureSectionView(request):
    allobjects = Creature.objects.all()

    paginator = Paginator(allobjects, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/creature_section.html",{'results':objects})

def LocationSectionView(request):
    allobjects = Location.objects.all()

    paginator = Paginator(allobjects, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/location_section.html",{'results':objects})

def ObjectSectionView(request):
    allobjects = Object.objects.all()

    paginator = Paginator(allobjects, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/object_section.html",{'results':objects})


def AdventureSectionView(request):
    allobjects = Adventure.objects.all()

    paginator = Paginator(allobjects, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/adventure_section.html",{'results':objects})

def ChronicleSectionView(request):
    allobjects = Chronicle.objects.all()

    paginator = Paginator(allobjects, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/chronicle_section.html",{'results':objects})


def getRelatedByTags(anObject):

    char_related_by_tags = Character.objects.filter(tags__name__in=anObject.tags.values_list('name',flat=True)).exclude(id=anObject.id).distinct()
    obj_related_by_tags = Object.objects.filter(tags__name__in=anObject.tags.values_list('name',flat=True)).exclude(id=anObject.id).distinct()
    adv_related_by_tags = Adventure.objects.filter(tags__name__in=anObject.tags.values_list('name',flat=True)).exclude(id=anObject.id).distinct()
    loc_related_by_tags = Location.objects.filter(tags__name__in=anObject.tags.values_list('name',flat=True)).exclude(id=anObject.id).distinct()

    relatedobjects = {"characters":char_related_by_tags,"objects":obj_related_by_tags,"adventures":adv_related_by_tags,"locations":loc_related_by_tags}
    return relatedobjects

def LocationDetailView(request, pk):
    location = Location.objects.get(id=pk)


    relatedobjectsbytags = getRelatedByTags(location)

    charlocs = CharacterLocationRelationship.objects.filter(location__name = location.name).order_by('-relation')
    oc = [o.character for o in charlocs]
    location.orderedchars = oc
    


    return render_to_response('web/location_detail.html', {
            "object": location, "relatedobjectsbytags":relatedobjectsbytags,'MEDIA_URL':MEDIA_URL,'STATIC_URL':STATIC_URL,
    })


def AdventureDetailView(request, pk):
    adventure = Adventure.objects.get(id=pk)


    relatedobjectsbytags = getRelatedByTags(adventure)

    return render_to_response('web/adventure_detail.html', {
            "object": adventure, "relatedobjectsbytags":relatedobjectsbytags,'MEDIA_URL':MEDIA_URL,'STATIC_URL':STATIC_URL,
    })


def ChronicleDetailView(request, pk):
    chronicle = Chronicle.objects.get(id=pk)


    relatedobjectsbytags = getRelatedByTags(chronicle)

    return render_to_response('web/chronicle_detail.html', {
            "object": chronicle, "relatedobjectsbytags":relatedobjectsbytags,'MEDIA_URL':MEDIA_URL,'STATIC_URL':STATIC_URL,
    })


def getObjectRelations(anObject):

	objectlist1 = ObjectRelationship.objects.filter(object1__name = anObject.name)
	objectlist2 = ObjectRelationship.objects.filter(object2__name = anObject.name)

	return (objectlist1,objectlist2)


def ObjectDetailView(request, pk):
    obj = Object.objects.get(id=pk)

    relatedobjectsbytags = getRelatedByTags(obj)
    relatedobjects = getObjectRelations(obj)

    return render_to_response("web/object_detail.html",{"object":obj, "relatedobjectsbytags":relatedobjectsbytags,"relatedobjects1":relatedobjects[0],"relatedobjects2":relatedobjects[1], 'MEDIA_URL':MEDIA_URL,'STATIC_URL':STATIC_URL,})

def SearchRedirectView(request):

    searchfilter = request.GET.get('option')
    searchterm = request.GET.get('searchterm')

    return HttpResponseRedirect("/search/%s/%s"%(searchfilter, searchterm))


def SimpleSearchView(request, searchfilter, searchterm="", canonlvl="ALL"):
    if searchterm in ["ALL","NEW","AP","APC","C"]: searchterm=""

    if searchterm!="": keywords = split_query_into_keywords(searchterm)
    else: keywords = []
    results = []
    allobjects = {}

    if searchfilter == 'object' and canonlvl=="ALL":
        allobjects[searchfilter] = Object.objects.all()
    elif searchfilter == 'object' and canonlvl!="ALL":
        allobjects[searchfilter] = Object.objects.filter(canon_level=canonlvl)

    elif searchfilter == 'character' and canonlvl=="ALL":
        allobjects[searchfilter] = Character.objects.all()
    elif searchfilter == 'character' and canonlvl!="ALL":
        allobjects[searchfilter] = Character.objects.filter(canon_level=canonlvl)

    elif searchfilter == 'creature'  and canonlvl=="ALL":
        allobjects[searchfilter] = Creature.objects.all()
    elif searchfilter == 'creature'  and canonlvl!="ALL":
        allobjects[searchfilter] = Creature.objects.filter(canon_level=canonlvl)

    elif searchfilter == 'chronicle' and canonlvl=="ALL":
        allobjects[searchfilter] = Chronicle.objects.all()
    elif searchfilter == 'chronicle' and canonlvl!="ALL":
        allobjects[searchfilter] = Chronicle.objects.filter(canon_level=canonlvl)

    elif searchfilter == 'adventure' and canonlvl=="ALL":
        allobjects[searchfilter] = Adventure.objects.all()
    elif searchfilter == 'adventure' and canonlvl!="ALL":
        allobjects[searchfilter] = Adventure.objects.filter(canon_level=canonlvl)


    elif searchfilter == 'location' and canonlvl=="ALL":
        allobjects[searchfilter] = Location.objects.all()
    elif searchfilter == 'location'  and canonlvl!="ALL":
        allobjects[searchfilter] = Location.objects.filter(canon_level=canonlvl)


    else:
        if canonlvl=="ALL":
            allobjects = {'object':Object.objects.all(),'character':Character.objects.all(),'creature':Creature.objects.all(),'chronicle':Chronicle.objects.all(),'adventure':Adventure.objects.all(),'location':Location.objects.all()}        
        else:
            allobjects = {'object':Object.objects.filter(canon_level=canonlvl),'character':Character.objects.filter(canon_level=canonlvl),'creature':Creature.objects.filter(canon_level=canonlvl),'chronicle':Chronicle.objects.filter(canon_level=canonlvl),'adventure':Adventure.objects.filter(canon_level=canonlvl),'location':Location.objects.filter(canon_level=canonlvl)}        



    if len(keywords) != 0:
        for objecttype, objectlist in allobjects.items():


            for ob in objectlist:
                ks = 0
                
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower().split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
        sresults = sorted(results, key=lambda anobject: anobject.hits, reverse=True)
    else: sresults = allobjects.items()

    object_list = sresults
    paginator = Paginator(object_list, 5) # Show 25 contacts per page

    page = request.GET.get('page')
    try:
        objects = paginator.page(page)
    except PageNotAnInteger:
        # If page is not an integer, deliver first page.
        objects = paginator.page(1)
    except EmptyPage:
        # If page is out of range (e.g. 9999), deliver last page of results.
        objects = paginator.page(paginator.num_pages)

    #return render_to_response('list.html', {"contacts": contacts})


    return render_to_response("web/listado.html",{'keywords':keywords,'results':objects})


def split_query_into_keywords(query):
    """Split the query into keywords,
    where keywords are double quoted together,
    use as one keyword."""
    keywords = []
    if type(query) == type(None): return keywords
    # Deal with quoted keywords
    while '"' in query:
        first_quote = query.find('"')
        second_quote = query.find('"', first_quote + 1)
        quoted_keywords = query[first_quote:second_quote + 1]
        keywords.append(quoted_keywords.strip('"'))
        query = query.replace(quoted_keywords, ' ')
    # Split the rest by spaces
    keywords.extend(query.split())
    return keywords


def AdvancedSearchView(request):
    choices_dict = {}
    locations_options = {'locations':Location.objects.all()}
    character_options = {"ALIGN_CHOICES":ALIGN_CHOICES, "PROFESSION_CHOICES":PROFESSION_CHOICES, "SPECIES_CHOICES":SPECIES_CHOICES, "LEVEL_CHOICES":LEVEL_CHOICES}
    creature_options = {"CRE_ALIGN_CHOICES":CRE_ALIGN_CHOICES}
    location_options = {"LOC_STATUS_CHOICES":LOC_STATUS_CHOICES,"ALIGN_CHOICES":ALIGN_CHOICES,"LOC_TYPE_CHOICES":LOC_TYPE_CHOICES}
    object_options = {"OBJ_STATUS_CHOICES":OBJ_STATUS_CHOICES,"ALIGN_CHOICES":ALIGN_CHOICES,"OBJ_RARITY_CHOICES":OBJ_RARITY_CHOICES,"OBJ_TYPE_CHOICES":OBJ_TYPE_CHOICES}
    adventure_options = {"PRICE_RANGES":PRICE_RANGES}
    range_options = {"lownum":range(1,11),"highnum":range(1,26)}
    adventures_options = {'adventures':Adventure.objects.all()}


    choices_dict.update(character_options)
    choices_dict.update(creature_options)
    choices_dict.update(location_options)
    choices_dict.update(object_options)
    choices_dict.update(locations_options)
    choices_dict.update(adventure_options)
    choices_dict.update(range_options)
    choices_dict.update(adventures_options)
    return render_to_response("web/advanced-search.html", choices_dict)


def ResultsAdvancedSearchView(request):

    #searchfilter = request.GET.get('option') #HERE WE WILL KNOW THE SPECIFIC OBJECT TYPE
    searchterm = request.GET.get('searchterm') #FIXME cuando null
    keywords = split_query_into_keywords(searchterm) or []
    objects = Location.objects.all()
    objecttype = request.GET.get('option') #FIXME cuando null
    objectcanon = request.GET.get('canon_level') #FIXME cuando null


    if objecttype == 'ALL':

        if searchterm in ["ALL","NEW","AP","APC","C"]: searchterm=""
        return HttpResponseRedirect("/search/%s/%s/%s"%(objecttype.lower(), objectcanon, searchterm))

    if objecttype == 'chronicle':

        chr_adventure = request.GET.get('chr_adventure') or None
        
        objects = Chronicle.objects.all()

        if chr_adventure!="ALL" and chr_adventure:
            objects = objects.filter(adventure=chr_adventure)

        if objectcanon!="ALL" and objectcanon:
            objects = objects.filter(canon_level=objectcanon)

#        for f,ft in filterdict.items():
#            if ft!=None: objects = objects.filter(f=ft)

        if len(keywords) != 0:
            results = []
            for ob in objects:
                ks = 0
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower():#.split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                        
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
                
        else: results = objects
        return render_to_response("web/advancedlisting.html",{'objecttype':'chronicle','keywords':keywords,'results':results})


    if objecttype == 'adventure':

        adv_level = request.GET.get('adv_level') or None
        adv_numplayers = request.GET.get('adv_numplayers') or None
        adv_price = request.GET.get('adv_price') or None
        adv_numsessions = request.GET.get('adv_numsessions') or None
        
        objects = Adventure.objects.all()

        if adv_level!="ALL" and adv_level:
            objects = objects.filter(minlevel__gte=adv_level)
        if adv_numplayers!="ALL" and adv_numplayers:
            objects = objects.filter(minnumplayers__lte=adv_numplayers)
        if adv_price!="ALL" and adv_price:
            objects = objects.filter(price=adv_price)
        if adv_numsessions!="ALL" and adv_numsessions:
            objects = objects.filter(sessions=sessions)


        if objectcanon!="ALL" and objectcanon:
            objects = objects.filter(canon_level=objectcanon)

#        for f,ft in filterdict.items():
#            if ft!=None: objects = objects.filter(f=ft)

        if len(keywords) != 0:
            results = []
            for ob in objects:
                ks = 0
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower():#.split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                        
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
                
        else: results = objects
        return render_to_response("web/advancedlisting.html",{'objecttype':'adventure','keywords':keywords,'results':results})


    if objecttype == 'object':

        obj_type = request.GET.get('obj_type') or None
        obj_rarity = request.GET.get('obj_rarity') or None
        obj_status = request.GET.get('obj_status') or None
        obj_alignment = request.GET.get('obj_alignment') or None
        obj_location = request.GET.get('obj_location') or None

        
        objects = Object.objects.all()

        if obj_type!="ALL" and obj_type:
            objects = objects.filter(objtype=obj_type)
        if obj_rarity!="ALL" and obj_rarity:
            objects = objects.filter(rarity=obj_rarity)
        if obj_status!="ALL" and obj_status:
            objects = objects.filter(status=obj_status)
        if obj_alignment!="ALL" and obj_alignment:
            objects = objects.filter(alignment=obj_alignment)
        if obj_location!="ALL" and obj_location:
            objects = objects.filter(relatedlocation=obj_location)

        if objectcanon!="ALL" and objectcanon:
            objects = objects.filter(canon_level=objectcanon)

#        for f,ft in filterdict.items():
#            if ft!=None: objects = objects.filter(f=ft)

        if len(keywords) != 0:
            results = []
            for ob in objects:
                ks = 0
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower():#.split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                        
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
                
        else: results = objects
        return render_to_response("web/advancedlisting.html",{'objecttype':'object','keywords':keywords,'results':results})


    if objecttype == 'creature':

        crea_ac = request.GET.get('crea_ac') or None
        crea_minpx = request.GET.get('crea_minpx') or None
        crea_hitdice = request.GET.get('crea_hitdice') or None
        crea_alignment = request.GET.get('crea_alignment') or None
        crea_location = request.GET.get('crea_location') or None

        
        objects = Creature.objects.all()

        if crea_ac!="ALL" and crea_ac:
            objects = objects.filter(AC__icontains=crea_ac)
        if crea_hitdice!="ALL" and crea_hitdice:
            objects = objects.filter(hitdice__icontains=crea_hitdice)
        if crea_minpx!="ALL" and crea_minpx:
            objects = objects.filter(XPvalue__gte=crea_minpx)
        if crea_alignment!="ALL" and crea_alignment:
            objects = objects.filter(alignment__icontains=crea_alignment)
        if crea_location!="ALL" and crea_location:
            objects = objects.filter(relatedlocation=crea_location)

        if objectcanon!="ALL" and objectcanon:
            objects = objects.filter(canon_level=objectcanon)

#        for f,ft in filterdict.items():
#            if ft!=None: objects = objects.filter(f=ft)

        if len(keywords) != 0:
            results = []
            for ob in objects:
                ks = 0
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower():#.split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                        
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
                
        else: results = objects
        return render_to_response("web/advancedlisting.html",{'objecttype':'creature','keywords':keywords,'results':results})



    if objecttype == 'character':

        char_species = request.GET.get('char_species') or None
        char_minlevel = request.GET.get('char_minlevel') or None
        char_profession = request.GET.get('char_profession') or None
        char_alignment = request.GET.get('char_alignment') or None
        char_location = request.GET.get('char_location') or None

        filterdict = {'specie':char_species,'level':char_minlevel,'alignment':char_alignment, 'profession':char_profession, 'location':char_location}

        
        objects = Character.objects.all()

        if char_species!="ALL" and char_species:
            objects = objects.filter(species=char_species)
        if char_minlevel!="ALL" and char_minlevel:
            objects = objects.filter(level__gte=char_minlevel)
        if char_profession!="ALL" and char_profession:
            objects = objects.filter(profession=char_profession)
        if char_alignment!="ALL" and char_alignment:
            objects = objects.filter(alignment=char_alignment)
        if char_location!="ALL" and char_location:
            objects = objects.filter(relatedlocation=char_location)

        if objectcanon!="ALL" and objectcanon:
            objects = objects.filter(canon_level=objectcanon)

#        for f,ft in filterdict.items():
#            if ft!=None: objects = objects.filter(f=ft)

        if len(keywords) != 0:
            results = []
            for ob in objects:
                ks = 0
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower():#.split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                        
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
                
        else: results = objects
        return render_to_response("web/advancedlisting.html",{'objecttype':'character','keywords':keywords,'results':results})


    if objecttype == 'location':


        loc_type = request.GET.get('loc_type') or None
        loc_status = request.GET.get('loc_status') or None
        loc_alignment = request.GET.get('loc_alignment') or None

        filterdict = {'loctype':loc_type,'status':loc_status,'alignment':loc_alignment}

        
        objects = Location.objects.all()

        if loc_type!="ALL" and loc_type:
            objects = objects.filter(loctype=loc_type)
        if loc_status!="ALL" and loc_status:
            objects = objects.filter(status=loc_status)
        if loc_alignment!="ALL" and loc_alignment:
            objects = objects.filter(alignment=loc_alignment)

        if objectcanon!="ALL" and objectcanon:
            objects = objects.filter(canon_level=objectcanon)

#        for f,ft in filterdict.items():
#            if ft!=None: objects = objects.filter(f=ft)

        if len(keywords) != 0:
            results = []
            for ob in objects:
                ks = 0
                for keyword in keywords:
                    if keyword.lower() in ob.searchText().lower():#.split(" "):
                        ks+=5
                        ks+=ob.searchText().lower().count(keyword.lower())
                        
                    if ks>0:
                        ob.hits = ks
                        ob.objecttype = objecttype
                        results.append(ob)
                
        else: results = objects
        return render_to_response("web/advancedlisting.html",{'objecttype':'location','keywords':keywords,'results':results})

    return render_to_response("web/advancedlisting.html",{'objecttype':'location','keywords':keywords,'results':objects})
